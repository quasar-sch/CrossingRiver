<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê°• ê±´ë„ˆê¸° í¼ì¦ â›µ v1.1</title>
<style>
  :root { --bg:#f4fbff; --ink:#1f2937; --accent:#0ea5e9; --card:#ffffffcc; }
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;background:var(--bg);color:var(--ink)}
  .hidden{display:none!important}
  .center-col{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
  .btn{padding:12px 18px;border-radius:14px;border:1px solid #dbe5ef;font-size:16px;font-weight:700;cursor:pointer;background:#fff;box-shadow:0 6px 14px rgba(0,0,0,.06);transition:.2s}
  .btn.primary{background:linear-gradient(180deg,#38bdf8,#0ea5e9);color:#fff;border:none}
  .btn.next{background:linear-gradient(180deg,#34d399,#059669);color:#fff;border:none}
  .container{max-width:1100px;margin:0 auto;padding:20px}
  .hud{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin:10px 0 10px}
  .pill{padding:6px 10px;border-radius:999px;background:#eef6ff;color:#1d4ed8;border:1px solid #c7dbff;font-weight:700}

  /* ê·œì¹™ ë°°ë„ˆ */
  .rule-banner{
    margin:8px 0 14px;
    padding:10px 14px;
    border-radius:12px;
    background:#ffffffcc;
    border:1px solid #dbe5ef;
    box-shadow:0 6px 14px rgba(0,0,0,.06);
    font-size:14px; line-height:1.4;
  }

  /* ë³´ë“œ ë ˆì´ì•„ì›ƒ */
  .board{position:relative;width:100%;height:540px;border-radius:18px;overflow:hidden;border:1px solid #e5e7eb;background:#bfe8ff}
  .river{
    position:absolute;top:0;bottom:0;left:50%;transform:translateX(-50%);
    width:50%;
    background:linear-gradient(180deg,#8dd7ff,#54b9f0 60%,#4aa8e0)
  }
  .bank{
    position:absolute;top:0;bottom:0;width:25%;
    display:flex;flex-direction:column;justify-content:flex-end;gap:8px;
    padding:10px 12px 28px;
    background:linear-gradient(#cfe9a6,#a7d47d);z-index:1
  }
  .bank.left{left:0}.bank.right{right:0}
  .bank-title{position:absolute;top:8px;left:50%;transform:translateX(-50%);font-weight:800;background:#ffffffcc;padding:2px 10px;border-radius:999px}
  .dock{display:flex;flex-wrap:wrap;gap:8px}

  .boat-wrap{
    position:absolute;top:calc(58% - 165px); /* ë°° ë†’ì´ 110px Ã— 1.5 ë§Œí¼ ìœ„ë¡œ */
    transform:translate(-50%,-50%);
    transition:left 1.1s cubic-bezier(0.65,0,0.35,1);
    z-index:2
  }
  .boat-wrap.moving{animation:bob .5s ease-in-out infinite alternate}
  @keyframes bob{from{transform:translate(-50%,-50%) rotate(-1deg)}to{transform:translate(-50%,-52%) rotate(1deg)}}

  .boat{position:relative;width:360px;max-width:86%;height:110px;background:#8b5a2b;border-radius:12px;transition:.25s}
  .slots{position:absolute;left:8px;right:8px;bottom:8px;height:96px;display:flex;gap:10px;justify-content:center;align-items:flex-end;flex-wrap:wrap}
  .slot{width:88px;height:88px;border:2px dashed #ffffff99;border-radius:12px;background:#ffffff22;display:flex;align-items:center;justify-content:center;color:#fff}

  .token{width:88px;height:88px;border-radius:16px;background:var(--card);border:1px solid #e5e7eb;box-shadow:0 6px 12px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;font-size:40px;cursor:grab}

  .result{position:absolute;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:10}
  .result .card{background:#fff;border-radius:18px;padding:24px;width:min(560px,88vw);text-align:center}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
  .modal{background:#fff;border-radius:16px;padding:20px;max-width:600px}

  .times{margin:12px auto 0;max-width:420px;text-align:left}
  .times .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #e5e7eb}
  .times .row.total{font-weight:800}

  /* â–¼ ë‹¨ê³„ë³„ ë³´íŠ¸/ìŠ¬ë¡¯ ê·œì¹™ (íŒŒì¼ í•˜ë‹¨ì— ìœ„ì¹˜í•´ì•¼ ìš°ì„  ì ìš©) */
  /* 1~4ë‹¨ê³„: ë‘ ì¹¸ ì „ìš© */
  .boat.two{width:360px;height:110px;}
  .boat.two #slotC,
  .boat.two #slotD{display:none !important;}

  /* 5ë‹¨ê³„: í° ë³´íŠ¸ + 2Ã—2 ê³ ì • + ìœ„ì¹˜ ì—¬ë°± íŠœë‹ */
  .boat.big{width:460px;height:210px;}
  .boat.big .slots{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    grid-template-rows:repeat(2,1fr);
    gap:12px;
    left:16px; right:16px; bottom:14px; height:auto;
    justify-items:center; align-items:end;
  }
  /* â–² ë‹¨ê³„ë³„ ë³´íŠ¸/ìŠ¬ë¡¯ ê·œì¹™ ë */
</style>
</head>
<body>
<main id="menu" class="center-col">
  <h1>ê°• ê±´ë„ˆê¸° í¼ì¦ â›µ</h1>
  <button class="btn primary" id="startBtn">ğŸš€ ê²Œì„ ì‹œì‘</button>
</main>

<div id="rulesModal" class="modal-backdrop">
  <div class="modal">
    <h3>ê²Œì„ ê·œì¹™</h3>
    <p id="ruleText"></p>
    <div style="margin-top:14px;text-align:right">
      <button class="btn primary" id="closeRules">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<section id="game" class="container hidden">
  <div class="hud">
    <div class="left">
      <span class="pill">ìŠ¤í…Œì´ì§€: <b id="stageName"></b></span>
      <span class="pill">ë³´íŠ¸ ìœ„ì¹˜: <b id="boatSideLabel"></b></span>
      <span class="pill">ê²½ê³¼ì‹œê°„: <b id="elapsed">00:00</b></span>
    </div>
    <div class="right">
      <button class="btn small" id="rulesBtn">ğŸ“œ ê·œì¹™</button>
      <button class="btn small" id="resetBtn">â†º ë¦¬ì…‹</button>
      <button class="btn small primary" id="moveBtn">â›µ ì´ë™</button>
    </div>
  </div>

  <!-- ê·œì¹™ ë°°ë„ˆ (HUD ì•„ë˜) -->
  <div class="rule-banner" id="ruleBanner"></div>

  <div class="board">
    <div class="bank left"><div class="bank-title">ì™¼ìª½ ë‘‘</div><div class="dock" id="dock-left"></div></div>
    <div class="river"></div>
    <div class="boat-wrap" id="boatWrap">
      <div class="boat" id="boat">
        <div class="slots">
          <div class="slot" id="slotA"></div>
          <div class="slot" id="slotB"></div>
          <div class="slot" id="slotC"></div>
          <div class="slot" id="slotD"></div>
        </div>
      </div>
    </div>
    <div class="bank right"><div class="bank-title">ì˜¤ë¥¸ìª½ ë‘‘</div><div class="dock" id="dock-right"></div></div>
    <div class="result" id="overlay">
      <div class="card">
        <h2 id="overlayTitle"></h2>
        <p id="overlayMsg"></p>
        <div id="finalTimes" class="times hidden"></div>
        <p id="timeMsg"></p>
        <button class="btn next" id="nextBtn">ë‹¤ìŒ ìŠ¤í…Œì´ì§€</button>
        <button class="btn primary" id="replayBtn">ë‹¤ì‹œ ë„ì „</button>
        <button class="btn" id="homeBtn">ì²˜ìŒìœ¼ë¡œ</button>
      </div>
    </div>
  </div>
</section>

<script>
const STAGES=[
 {name:"1ë‹¨ê³„ Â· ëŠ‘ëŒ€, ì–‘ ê·¸ë¦¬ê³  ì–‘ë°°ì¶”",tokens:["person","wolf","goat","cabbage"],capacity:2,requiresPerson:true,
  ruleText:"ì‚¬ëŒë§Œ ë°°ì˜ ë…¸ë¥¼ ì €ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ëŒì´ ì—†ëŠ” ë‘‘ì—ì„œ ëŠ‘ëŒ€+ì–‘ ë˜ëŠ” ì–‘+ì–‘ë°°ì¶”ê°€ ë‚¨ìœ¼ë©´ ê²Œì„ ì˜¤ë²„ì…ë‹ˆë‹¤.",
  rules:(pos,side)=>{
    const b={L:[],R:[]};
    for(const t in pos){const s=pos[t]==="BOAT"?side:pos[t];b[s].push(t);}
    if(!b.L.includes("person")){
      if(b.L.includes("wolf")&&b.L.includes("goat"))return"ì™¼ìª½: ëŠ‘ëŒ€ê°€ ì–‘ì„ ë¨¹ìŒ";
      if(b.L.includes("goat")&&b.L.includes("cabbage"))return"ì™¼ìª½: ì–‘ì´ ì–‘ë°°ì¶”ë¥¼ ë¨¹ìŒ";
    }
    if(!b.R.includes("person")){
      if(b.R.includes("wolf")&&b.R.includes("goat"))return"ì˜¤ë¥¸ìª½: ëŠ‘ëŒ€ê°€ ì–‘ì„ ë¨¹ìŒ";
      if(b.R.includes("goat")&&b.R.includes("cabbage"))return"ì˜¤ë¥¸ìª½: ì–‘ì´ ì–‘ë°°ì¶”ë¥¼ ë¨¹ìŒ";
    }
    return null;
  }},

 {name:"2ë‹¨ê³„ Â· ì„ êµì‚¬ì™€ ë±€íŒŒì´ì–´",tokens:["M1","M2","M3","V1","V2","V3"],capacity:2,requiresPerson:false,
  ruleText:"ì„ êµì‚¬/ë±€íŒŒì´ì–´ ëª¨ë‘ ë°°ë¥¼ ëª° ìˆ˜ ìˆê³ , ë°°ëŠ” ìµœëŒ€ 2ëª…ê¹Œì§€ íƒ‘ìŠ¹ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì–´ëŠ ë‘‘ì´ë“  ì„ êµì‚¬ê°€ ìˆê³  ë±€íŒŒì´ì–´ê°€ ì„ êµì‚¬ë³´ë‹¤ ë§ìœ¼ë©´ ê²Œì„ ì˜¤ë²„ì…ë‹ˆë‹¤.",
  rules:(pos,side)=>{
    const c={L:{M:0,V:0},R:{M:0,V:0}};
    for(const t in pos){
      const s=pos[t]==="BOAT"?side:pos[t];
      if(t.startsWith("M"))c[s].M++; else c[s].V++;
    }
    for(const s of["L","R"]) if(c[s].M>0&&c[s].V>c[s].M) return `${s==="L"?"ì™¼ìª½":"ì˜¤ë¥¸ìª½"}: ë±€íŒŒì´ì–´ê°€ ì„ êµì‚¬ë¥¼ ì¡ì•„ë¨¹ìŒ`;
    return null;
  }},

 {name:"3ë‹¨ê³„ Â· ì—˜í”„Â·ì¢€ë¹„Â·ë§ˆë²•ì‚¬",tokens:["ElfBoss","Elf","ZombieBoss","Zombie","WizardBoss","Wizard"],capacity:2,requiresPerson:false,
  ruleText:"ë¶€í•˜ëŠ” ìê¸° ë‘ëª©ì´ ìˆì„ ë•Œë§Œ ì•ˆì „í•©ë‹ˆë‹¤. ë‘ëª© ì—†ì´ ë‹¤ë¥¸ ë‘ëª©ê³¼ë§Œ í•¨ê»˜ ìˆìœ¼ë©´ ìœ„í—˜í•©ë‹ˆë‹¤.",
  rules:(pos,side)=>{
    const groups={"ElfBoss":"Elf","ZombieBoss":"Zombie","WizardBoss":"Wizard"};
    for(const s of["L","R"]){
      const here=Object.entries(pos).filter(([k,v])=>(v==="BOAT"?side:v)===s).map(([k])=>k);
      for(const [boss,minion] of Object.entries(groups)){
        if(here.includes(minion)&&!here.includes(boss)){
          const otherBoss=Object.keys(groups).filter(b=>b!==boss&&here.includes(b));
          if(otherBoss.length) return `${s==="L"?"ì™¼ìª½":"ì˜¤ë¥¸ìª½"}: ${minion}ì´ ë‹¤ë¥¸ ë‘ëª©ê³¼ë§Œ ìˆì–´ ìœ„í—˜!`;
        }
      }
    }
    return null;
  }},

 {name:"4ë‹¨ê³„ Â· ì™¸ê³„ì¸! ì‚¬ìœ¡ì‚¬ì™€ ì‚¬ì",tokens:["A","A1","A2","B","B1","B2","Keeper","Lion"],capacity:2,requiresPerson:false,
  ruleText:"A/B ë¶€ëª¨ê°€ ì—†ìœ¼ë©´ ìƒëŒ€ì˜ ì•„ì´ë¥¼ ê´´ë¡­í™ë‹ˆë‹¤. ì‚¬ìëŠ” ì‚¬ìœ¡ì‚¬ê°€ ì—†ìœ¼ë©´ ìœ„í—˜í•©ë‹ˆë‹¤. ë…¸ëŠ” A,B,Keeperë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
  rules:(pos,side)=>{
    const info=s=>Object.entries(pos).filter(([k,v])=>(v==="BOAT"?side:v)===s).map(([k])=>k);
    for(const s of["L","R"]){
      const h=info(s);
      if((h.includes("A1")||h.includes("A2")) && !h.includes("A") && h.includes("B")) return `${s==="L"?"ì™¼ìª½":"ì˜¤ë¥¸ìª½"}: Bê°€ Aì˜ ì•„ì´ë¥¼ ê´´ë¡­í˜`;
      if((h.includes("B1")||h.includes("B2")) && !h.includes("B") && h.includes("A")) return `${s==="L"?"ì™¼ìª½":"ì˜¤ë¥¸ìª½"}: Aê°€ Bì˜ ì•„ì´ë¥¼ ê´´ë¡­í˜`;
      if(h.includes("Lion") && !h.includes("Keeper")) return `${s==="L"?"ì™¼ìª½":"ì˜¤ë¥¸ìª½"}: ì‚¬ìê°€ ë‚ ëœ€`;
    }
    return null;
  }},

 {name:"5ë‹¨ê³„ Â· ì¡°ë ¨ì‚¬ì™€ ë™ë¬¼ë“¤",tokens:["Trainer","Elephant","Tiger","Dog","Cat","Mouse"],capacity:4,requiresPerson:true,
  ruleText:"ë°° ì´ë™ì€ í•­ìƒ ì¡°ë ¨ì‚¬ ë™ìŠ¹ì´ í•„ìš”í•©ë‹ˆë‹¤. ë°° ì•ˆì—ì„œ: ì½”ë¼ë¦¬ëŠ” ì¥ ì™¸ ë‹¤ë¥¸ ë™ë¬¼ê³¼ ë™ìŠ¹ ë¶ˆê°€. í˜¸ë‘ì´ì™€ ê°•ì•„ì§€ëŠ” í•¨ê»˜ íƒˆ ìˆ˜ ì—†ì–´ìš”. ë‘‘ì—ì„œëŠ” ì¡°ë ¨ì‚¬ê°€ ì—†ì„ ë•Œ (ì½”-í˜¸, í˜¸-ê°œ, ê°œ-ê³ , ê³ -ì¥, ì¥-ì½”) ì‹¸ì›€.",
  rules:(pos,side)=>{
    const info=s=>Object.entries(pos).filter(([k,v])=> (v==="BOAT"?side:v)===s).map(([k])=>k);
    const boatMembers=Object.entries(pos).filter(([k,v])=> v==="BOAT").map(([k])=>k);
    const bHas = n=> boatMembers.includes(n);
    // ë°° ìœ„ ì œì•½(ì¡°ë ¨ì‚¬ ë™ìŠ¹ ì‹œ)
    if(boatMembers.length && bHas('Trainer')){
      if(bHas('Elephant') && boatMembers.some(x=> !['Elephant','Mouse','Trainer'].includes(x))){
        return 'ë°° ì•ˆ: ì½”ë¼ë¦¬ëŠ” ì¥ ì™¸ ë™ë¬¼ê³¼ í•¨ê»˜ íƒˆ ìˆ˜ ì—†ì–´ìš”';
      }
      if(bHas('Tiger') && bHas('Dog')){
        return 'ë°° ì•ˆ: í˜¸ë‘ì´ì™€ ê°•ì•„ì§€ëŠ” í•¨ê»˜ íƒˆ ìˆ˜ ì—†ì–´ìš”';
      }
    }
    // ë‘‘ì—ì„œì˜ ì‹¸ì›€ (ì¡°ë ¨ì‚¬ ì—†ì„ ë•Œë§Œ)
    const pairs = [["Elephant","Tiger"],["Tiger","Dog"],["Dog","Cat"],["Cat","Mouse"],["Mouse","Elephant"]];
    for(const s of ['L','R']){
      const here = info(s); const has = t=> here.includes(t);
      if(!has('Trainer')){
        for(const [a,b] of pairs){ if(has(a)&&has(b)) return `${s==='L'?'ì™¼ìª½':'ì˜¤ë¥¸ìª½'}: ${a}ì™€ ${b}ê°€ ì‹¸ì›€`; }
      }
    }
    return null;
  }
 }
];

const $=s=>document.querySelector(s);
let state={stageIndex:0,positions:{},boatSide:"L",moving:false,startTs:null,timerId:null,devCheat:false,stageTimes:Array(STAGES.length).fill(null)};
const leftDock=$("#dock-left"),rightDock=$("#dock-right"),boatWrap=$("#boatWrap"),boat=$("#boat");

/* ë³´ì´ëŠ” ìŠ¬ë¡¯ë§Œ ë°˜í™˜(ìˆ¨ê¸´ C/DëŠ” ì œì™¸) */
function getSlots(){
  return Array.from(document.querySelectorAll('.slot')).filter(s=>s.offsetParent!==null);
}

/* ê°• í­ì„ 50%ë¡œ í‚¤ì› ìœ¼ë¯€ë¡œ ë³´íŠ¸ ì¤‘ì•™ì„ ê°•ì˜ ì•ˆìª½ìœ¼ë¡œ: 35% / 65% */
function boatLeftPercent(s){return s==="L"?35:65}

function emoji(name){
  if(name==="Mouse")return"ğŸ­";
  if(name==="person")return"ğŸ§";if(name==="wolf")return"ğŸº";if(name==="goat")return"ğŸ‘";if(name==="cabbage")return"ğŸ¥¬";
  if(name.startsWith("M"))return"ğŸ§‘â€ğŸ¦³";if(name.startsWith("V"))return"ğŸ§›";
  if(name.startsWith("Elf"))return"ğŸ§";if(name.startsWith("Zombie"))return"ğŸ§Ÿ";if(name.startsWith("Wizard"))return"ğŸ§™";
  if(name==="A"||name==="A1"||name==="A2")return"ğŸ‘¾";if(name==="B"||name==="B1"||name==="B2")return"ğŸ‘½";
  if(name==="Keeper")return"ğŸ‘¨â€ğŸŒ¾";if(name==="Lion")return"ğŸ¦";
  if(name==="Trainer")return"ğŸ‘¨";if(name==="Elephant")return"ğŸ˜";if(name==="Tiger")return"ğŸ…";if(name==="Dog")return"ğŸ•";if(name==="Cat")return"ğŸˆ";
  return name;
}

function makeToken(name){
  const el=document.createElement("div");el.className="token";el.draggable=true;el.dataset.id=name;el.textContent=emoji(name);
  if(name.includes("Boss")) el.style.fontSize="48px";
  if(["Elf","Zombie","Wizard"].includes(name)) el.style.fontSize="28px";
  if(name==="A1"||name==="A2"||name==="B1"||name==="B2") el.style.fontSize="22px";
  el.addEventListener("dragstart",e=>{if(state.moving){e.preventDefault();return}e.dataTransfer.setData("text/plain",name)});
  return el;
}

function clearSlots(){
  leftDock.replaceChildren();
  rightDock.replaceChildren();
  Array.from(document.querySelectorAll('.slot')).forEach(s=>s.replaceChildren());
}

/* ë‹¨ê³„ë³„ ìŠ¬ë¡¯/ë³´íŠ¸ í¬ê¸° ì¡°ì • */
function adjustBoatSlots(){
  const st=STAGES[state.stageIndex];
  const slots=Array.from(document.querySelectorAll('.slot'));
  if(st.capacity===2){
    boat.classList.remove('big');
    boat.classList.add('two');
    if(slots[0]) slots[0].style.display="flex";
    if(slots[1]) slots[1].style.display="flex";
    if(slots[2]) slots[2].style.display="none";
    if(slots[3]) slots[3].style.display="none";
  }else{ // capacity === 4
    boat.classList.remove('two');
    boat.classList.add('big');
    slots.forEach(s=>s.style.display="flex");
  }
}

function render(){
  clearSlots();
  const st=STAGES[state.stageIndex];

  // ë³´íŠ¸/ìŠ¬ë¡¯ ëª¨ì–‘ì„ ë‹¨ê³„ì— ë§ì¶° ë¨¼ì € ì„¸íŒ…
  adjustBoatSlots();

  // í† í° ë Œë”
  for(const name of st.tokens){
    const pos=state.positions[name]; const el=makeToken(name);
    if(pos==="L") leftDock.appendChild(el);
    else if(pos==="R") rightDock.appendChild(el);
    else if(pos==="BOAT"){
      const tgt = getSlots().find(s=>s.childElementCount===0);
      if(tgt) tgt.appendChild(el);
    }
  }

  $("#stageName").textContent=st.name;
  $("#ruleText").textContent=st.ruleText;       // ëª¨ë‹¬ìš©
  $("#ruleBanner").textContent=st.ruleText;     // ë°°ë„ˆ í‘œì‹œ
  $("#boatSideLabel").textContent=state.boatSide==="L"?"ì™¼ìª½":"ì˜¤ë¥¸ìª½";
  boatWrap.style.left=boatLeftPercent(state.boatSide)+"%";

  const fail=st.rules(state.positions,state.boatSide);
  if(fail) return showOverlay(false,fail);
  if(Object.values(state.positions).every(v=>"R"===v)) showOverlay(true,"ì„±ê³µ!");
}

function currentBoatCount(){return Object.values(state.positions).filter(v=>v==="BOAT").length}

const leftDockEl=$("#dock-left");
const rightDockEl=$("#dock-right");

const boatEl=$("#boat");
boatEl.addEventListener("dragover",e=>{if(!state.moving)e.preventDefault()});
boatEl.addEventListener("drop",e=>{
  if(state.moving)return;
  e.preventDefault();
  const name=e.dataTransfer.getData("text/plain"); if(!name)return;
  const st=STAGES[state.stageIndex];
  if(state.positions[name]!=="BOAT"&&currentBoatCount()>=st.capacity)return;
  const same=(state.positions[name]===state.boatSide)||(state.positions[name]==="BOAT");
  if(!same)return;
  state.positions[name]=(state.positions[name]==="BOAT")?state.boatSide:"BOAT";
  render();
});

[leftDockEl,rightDockEl].forEach(dock=>{
  dock.addEventListener("dragover",e=>{if(!state.moving)e.preventDefault()});
  dock.addEventListener("drop",e=>{
    if(state.moving)return;
    e.preventDefault();
    const name=e.dataTransfer.getData("text/plain"); if(!name)return;
    const side=(dock===leftDockEl)?"L":"R";
    if(state.positions[name]==="BOAT"&&state.boatSide===side){
      state.positions[name]=side; render();
    }
  });
});

function moveBoat(){
  if(state.moving)return;
  const st=STAGES[state.stageIndex];
  if(currentBoatCount()===0)return;
  if(st.requiresPerson && state.positions[st.tokens.includes('Trainer')?'Trainer':'person']!=="BOAT") return; // ì‚¬ëŒ(ì¡°ë ¨ì‚¬) í•„ìˆ˜
  if(currentBoatCount()>st.capacity)return;

  state.boatSide=state.boatSide==="L"?"R":"L";
  state.moving=true; boatWrap.classList.add("moving");
  boatWrap.style.left=boatLeftPercent(state.boatSide)+"%";
  setTimeout(()=>{
    boatWrap.classList.remove("moving");
    for(const k in state.positions){ if(state.positions[k]==="BOAT") state.positions[k]=state.boatSide; }
    state.moving=false; render();
  },1100);
}

/* ì˜¤ë²„ë ˆì´ ë° íƒ€ì´ë° */
const overlay=$("#overlay"),overlayTitle=$("#overlayTitle"),overlayMsg=$("#overlayMsg"),timeMsg=$("#timeMsg"),nextBtn=$("#nextBtn"),replayBtn=$("#replayBtn"),homeBtn=$("#homeBtn"),finalTimes=$("#finalTimes");
function showOverlay(success,msg){
  clearInterval(state.timerId);
  overlayTitle.textContent=success?"ğŸ‰ ì„±ê³µ!":"âŒ ì‹¤íŒ¨";
  overlayMsg.textContent=msg||"";
  const elapsedMs=Date.now()-state.startTs;
  state.stageTimes[state.stageIndex]=elapsedMs;
  timeMsg.textContent=`ê¸°ë¡: ${formatTime(elapsedMs)}`;

  const isLast = success && state.stageIndex===STAGES.length-1;
  if(isLast){
    finalTimes.classList.remove("hidden");
    finalTimes.innerHTML = buildTimesHtml(state.stageTimes);
    nextBtn.style.display="none";
    homeBtn.style.display="inline-block";
  }else{
    finalTimes.classList.add("hidden");
    nextBtn.style.display=(success&&state.stageIndex<STAGES.length-1)?"inline-block":"none";
    homeBtn.style.display=(success&&state.stageIndex===STAGES.length-1)?"inline-block":"none";
  }
  replayBtn.style.display="inline-block";
  overlay.style.display="flex";
}
function buildTimesHtml(arr){
  const rows = arr.map((ms,i)=>`<div class="row"><span>ìŠ¤í…Œì´ì§€ ${i+1}</span><span>${ms!=null?formatTime(ms):"-"}</span></div>`).join("");
  const total = arr.reduce((a,b)=>a+(b||0),0);
  return rows + `<div class="row total"><span>í•©ê³„</span><span>${formatTime(total)}</span></div>`;
}
function hideOverlay(){overlay.style.display="none"}

function startStage(i){
  state.stageIndex=i;
  const st=STAGES[i];
  state.positions={}; st.tokens.forEach(t=>state.positions[t]="L");
  state.boatSide="L"; state.moving=false; boatWrap.style.left=boatLeftPercent("L")+"%";
  hideOverlay(); startTimer(); render();
}
function enterGame(){$("#menu").classList.add("hidden");$("#game").classList.remove("hidden");startStage(0);}
function enterMenu(){$("#menu").classList.remove("hidden");$("#game").classList.add("hidden");clearInterval(state.timerId);}
function startTimer(){state.startTs=Date.now();clearInterval(state.timerId);state.timerId=setInterval(()=>$("#elapsed").textContent=formatTime(Date.now()-state.startTs),200);}
function formatTime(ms){const s=Math.floor(ms/1000),m=Math.floor(s/60);return`${m}:${(s%60).toString().padStart(2,"0")}`}

$("#startBtn").addEventListener("click",enterGame);
$("#rulesBtn").addEventListener("click",()=>$("#rulesModal").style.display="flex");
$("#closeRules").addEventListener("click",()=>$("#rulesModal").style.display="none");
$("#resetBtn").addEventListener("click",()=>startStage(state.stageIndex));
$("#moveBtn").addEventListener("click",moveBoat);
nextBtn.addEventListener("click",()=>{hideOverlay();startStage(state.stageIndex+1)});
replayBtn.addEventListener("click",()=>{hideOverlay();startStage(state.stageIndex)});
homeBtn.addEventListener("click",()=>{hideOverlay();enterMenu()});

/* ê°œë°œì ì¹˜íŠ¸í‚¤
   - â‚© ë˜ëŠ” ` + â†/â†’ : ì´ì „/ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ë°”ë¡œ ì´ë™
   - â‚© ë˜ëŠ” ` + Enter : í˜„ì¬ ìŠ¤í…Œì´ì§€ ê°•ì œ ì„±ê³µ ì²˜ë¦¬
*/
function forceClearStage(){
  const st=STAGES[state.stageIndex];
  st.tokens.forEach(t=>state.positions[t]="R");
  render();
}
document.addEventListener("keydown",e=>{
  if(e.key==="â‚©" || e.key==="`" || e.code==="Backquote") state.devCheat=true;
  if(state.devCheat && e.key==="ArrowRight" && state.stageIndex<STAGES.length-1) startStage(state.stageIndex+1);
  if(state.devCheat && e.key==="ArrowLeft"  && state.stageIndex>0) startStage(state.stageIndex-1);
  if(state.devCheat && (e.key==="Enter" || e.code==="Enter")) { forceClearStage(); }
});
document.addEventListener("keyup",e=>{if(e.key==="â‚©" || e.key==="`" || e.code==="Backquote") state.devCheat=false});
</script>
</body>
</html>
